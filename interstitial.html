<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ADMENSION Redirect</title>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5584590642779290"
       crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./universal-ads/admension-ads.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; }
    body {
      font-family:'Space Grotesk', sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color:#fff;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      overflow-x:hidden;
    }
    #mainCard {
      background: rgba(255,255,255,0.05);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:2rem;
      max-width:600px;
      width:90%;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      text-align:center;
      border:1px solid rgba(255,255,255,0.1);
    }
    h1 {
      font-size:1.8rem;
      margin-bottom:1rem;
      background:linear-gradient(90deg,#6ee7b7,#3b82f6);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .message {
      background:rgba(255,255,255,0.08);
      padding:1rem;
      border-radius:8px;
      margin:1rem 0;
      font-size:1rem;
      line-height:1.5;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.1);
    }
    .instructions {
      background:rgba(59,130,246,0.15);
      padding:1rem;
      border-radius:8px;
      margin:1rem 0;
      font-size:0.95rem;
      line-height:1.6;
      color:#93c5fd;
      border:1px solid rgba(59,130,246,0.3);
      text-align:left;
    }
    .instructions ol {
      padding-left:1.5rem;
      margin-top:0.5rem;
    }
    .instructions li {
      margin:0.5rem 0;
    }
    .countdown {
      font-size:3rem;
      font-weight:700;
      margin:1.5rem 0;
      background:linear-gradient(90deg,#f59e0b,#ef4444);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .progress {
      display:flex;
      justify-content:center;
      gap:0.75rem;
      margin:1.5rem 0;
    }
    .dot {
      width:12px;
      height:12px;
      border-radius:50%;
      background:rgba(255,255,255,0.2);
      transition:background 0.3s;
    }
    .dot.active {
      background:linear-gradient(90deg,#6ee7b7,#3b82f6);
      box-shadow:0 0 12px rgba(110,231,183,0.6);
    }
    .btn {
      background:linear-gradient(90deg,#6ee7b7,#3b82f6);
      color:#111;
      border:none;
      padding:0.9rem 2rem;
      font-size:1rem;
      font-weight:600;
      border-radius:8px;
      cursor:pointer;
      transition:transform 0.2s, opacity 0.3s;
      font-family:inherit;
      margin-top:1rem;
    }
    .btn:hover:not(:disabled) {
      transform:scale(1.05);
    }
    .btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    .footer {
      margin-top:2rem;
      font-size:0.85rem;
      color:#9ca3af;
    }
    .footer a {
      color:#6ee7b7;
      text-decoration:none;
    }
    .footer a:hover {
      text-decoration:underline;
    }
    .hidden { display:none; }
  </style>
</head>
<body>

<!-- Step 1: Link name + instructions -->
<div id="step1" class="hidden">
  <div id="mainCard">
    <div id="tos_error_msg" class="message" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);display:none;margin-bottom:1rem">
      <strong>‚ùå You didn't agree to Terms of Service.</strong><br>
      Please review and agree to continue to the destination.
    </div>
    <h1 id="linkName">‚Äî</h1>
    <div class="instructions">
      <strong>Step 1 of 3</strong>
      <p>Click "Next" to start the 3-second timer.</p>
    </div>
    <div class="progress">
      <div class="dot active"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="countdown" id="timer1">3</div>
    <button class="btn" id="btn1">Next</button>
    <div class="footer">Powered by <a href="./">ADMENSION</a></div>
  </div>
</div>

<!-- Step 2: Daily Quote + Instructions -->
<div id="step2" class="hidden">
  <div id="mainCard">
    <div id="dailyQuoteStep2"></div>
    <div class="instructions" style="margin-top:1rem">
      <strong>Step 2 of 3</strong>
      <p id="step2_instruction">Page is unlocking... Please wait.</p>
    </div>
    <div class="progress">
      <div class="dot"></div>
      <div class="dot active"></div>
      <div class="dot"></div>
    </div>
    <div class="countdown" id="timer2">3</div>
    <button class="btn" id="btn2" disabled>Unlocking...</button>
    <div class="footer">Powered by <a href="./">ADMENSION</a></div>
  </div>
</div>

<!-- Step 3: Custom message + disclaimer + Agree/Disagree -->
<div id="step3" class="hidden">
  <div id="mainCard">
    <h1 id="linkName3">‚Äî</h1>
    <div class="message" id="customMessage">‚Äî</div>
    <div class="message" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);">
      <strong>‚ö†Ô∏è Terms of Service:</strong><br>
      We do not condone or associate with malicious links. This service is provided as-is for legitimate use only. Use at your own discretion.
    </div>
    <div style="margin:1rem 0;padding:1rem;background:rgba(255,255,255,0.05);border-radius:8px;border:1px solid rgba(255,255,255,0.1);text-align:left">
      <div style="margin-bottom:8px;font-weight:600">Do you agree to the Terms of Service?</div>
      <label style="display:block;margin-bottom:8px;cursor:pointer">
        <input type="radio" name="tos_radio" value="disagree" checked style="margin-right:8px">
        <span>‚ùå Disagree (will return to Step 1)</span>
      </label>
      <label style="display:block;cursor:pointer">
        <input type="radio" name="tos_radio" value="agree" style="margin-right:8px">
        <span>‚úÖ Agree to Terms of Service</span>
      </label>
    </div>
    <div class="instructions">
      <strong>Step 3 of 3 ‚Äî Final step:</strong>
      <p style="margin-top:8px;">Click "Next" to start the 10-second timer</p>
    </div>
    <div class="progress">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot active"></div>
    </div>
    <div class="countdown" id="timer3Big">10</div>
    <button class="btn" id="btn3">Next</button>
    <div class="footer">Powered by <a href="./">ADMENSION</a></div>
  </div>
</div>

<script src="./src/daily-quotes.js"></script>
<script src="./universal-ads/admension-ads.js"></script>
<script>
/* ===== ADMENSION Interstitial Page ===== */
// localStorage keys (sync with main index.html)
const K = { adm_refs: 'cfamm.adm_refs' };

// Parse URL to get code and step
const params = new URLSearchParams(location.search);
const code = params.get('code') || '';
const istep = parseInt(params.get('istep') || '1', 10);

// Load link data from localStorage
let linkData = null;
try {
  const refs = JSON.parse(localStorage.getItem(K.adm_refs) || '[]');
  linkData = refs.find(r => r.code === code.toUpperCase());
  
  // Update lastPageview and totalPageviews for traffic tracking
  if(linkData) {
    linkData.lastPageview = Date.now();
    linkData.totalPageviews = (linkData.totalPageviews || 0) + 1;
    // Save back to localStorage
    const refs = JSON.parse(localStorage.getItem(K.adm_refs) || '[]');
    const idx = refs.findIndex(r => r.code === code.toUpperCase());
    if(idx >= 0) {
      refs[idx] = linkData;
      localStorage.setItem(K.adm_refs, JSON.stringify(refs));
    }
  }
} catch(e) {
  console.error('Failed to load link data:', e);
}

// If no link data found, redirect to home
if(!linkData) {
  alert('Invalid or expired link code.');
  location.href = './';
}

// Track attribution (if ?adm=CODE present)
const admCode = params.get('adm');
if(admCode) {
  sessionStorage.setItem('admension_code', admCode);
}

// DOM elements
const step1El = document.getElementById('step1');
const step2El = document.getElementById('step2');
const step3El = document.getElementById('step3');
const linkNameEl = document.getElementById('linkName');
const linkName3El = document.getElementById('linkName3');
const customMessageEl = document.getElementById('customMessage');
const timer1El = document.getElementById('timer1');
const timer2El = document.getElementById('timer2');
const timer3BigEl = document.getElementById('timer3Big');
const btn1 = document.getElementById('btn1');
const btn2 = document.getElementById('btn2');
const btn3 = document.getElementById('btn3');

// Populate step 1 with link name
if(linkNameEl && linkData.linkName) {
  linkNameEl.textContent = linkData.linkName;
}

// Populate step 3 with link name and custom message (will be set when step 3 loads)
if(linkName3El && linkData.linkName) {
  linkName3El.textContent = linkData.linkName;
}
if(customMessageEl && linkData.message) {
  customMessageEl.textContent = linkData.message;
} else if(customMessageEl) {
  customMessageEl.textContent = 'Click the button below to continue to your destination.';
}

let currentStep = 1;

// Analytics: log page load
if(window.ADMENSION_ENGAGEMENT) {
  try {
    window.ADMENSION_ENGAGEMENT.logEvent('interstitial_load', {
      code: code,
      adm_code: admCode || 'none',
      step: 1,
      linkName: linkData.linkName,
      hasMessage: !!linkData.message
    });
  } catch(e) {}
}

// Show the appropriate step based on istep parameter
if(istep === 1) {
  step1El.classList.remove('hidden');
  
  // Check if user returned from ToS disagree
  const tosMsg = params.get('tos_msg');
  if(tosMsg === '1') {
    const tosErrorEl = document.getElementById('tos_error_msg');
    if(tosErrorEl) tosErrorEl.style.display = 'block';
  }
  
  // Timer doesn't auto-start - user must click Next
  timer1El.textContent = '3';
  btn1.disabled = false;
  btn1.textContent = 'Next';
  
  btn1.onclick = () => {
    btn1.disabled = true;
    btn1.textContent = 'Please wait...';
    btn1.style.background = 'rgba(255,255,255,0.1)';
    
    let countdown1 = 3;
    const interval1 = setInterval(() => {
      countdown1--;
      if(countdown1 < 0) countdown1 = 0;
      timer1El.textContent = countdown1;
      if(countdown1 === 0) {
        clearInterval(interval1);
        // Enable button for user to click again
        btn1.disabled = false;
        btn1.textContent = '‚úÖ Complete - Next';
        btn1.style.background = 'rgba(34,197,94,0.2)';
        btn1.style.border = '1px solid rgba(34,197,94,0.5)';
        btn1.onclick = () => {
          // Now trigger page reload
          const nu = new URL(location.href);
          nu.searchParams.set('istep', '2');
          location.href = nu.toString();
        };
      }
    }, 1000);
  };
} else if(istep === 2) {
  step2El.classList.remove('hidden');
  renderDailyQuoteStep2();
  
  // Auto-start unlock timer
  let countdown2unlock = 3;
  timer2El.textContent = countdown2unlock;
  btn2.disabled = true;
  btn2.textContent = 'Unlocking...';
  btn2.style.background = 'rgba(255,255,255,0.1)';
  
  const step2InstructionEl = document.getElementById('step2_instruction');
  if(step2InstructionEl) step2InstructionEl.textContent = 'Page is unlocking... Please wait.';
  
  const unlockInterval = setInterval(() => {
    countdown2unlock--;
    if(countdown2unlock < 0) countdown2unlock = 0;
    timer2El.textContent = countdown2unlock;
    if(countdown2unlock === 0) {
      clearInterval(unlockInterval);
      // Unlock complete - enable button for user to start main timer
      btn2.disabled = false;
      btn2.textContent = '‚úÖ Unlocked - Next';
      btn2.style.background = 'rgba(34,197,94,0.2)';
      btn2.style.border = '1px solid rgba(34,197,94,0.5)';
      if(step2InstructionEl) step2InstructionEl.textContent = 'Click "Next" to start the 3-second timer.';
      
      btn2.onclick = () => {
        // Start main timer
        btn2.disabled = true;
        btn2.textContent = 'Please wait...';
        btn2.style.background = 'rgba(255,255,255,0.1)';
        btn2.style.border = '';
        if(step2InstructionEl) step2InstructionEl.textContent = 'Please wait...';
        
        let countdown2main = 3;
        timer2El.textContent = countdown2main;
        const mainInterval = setInterval(() => {
          countdown2main--;
          if(countdown2main < 0) countdown2main = 0;
          timer2El.textContent = countdown2main;
          if(countdown2main === 0) {
            clearInterval(mainInterval);
            // Enable button for user to click again
            btn2.disabled = false;
            btn2.textContent = '‚úÖ Complete - Next';
            btn2.style.background = 'rgba(34,197,94,0.2)';
            btn2.style.border = '1px solid rgba(34,197,94,0.5)';
            if(step2InstructionEl) step2InstructionEl.textContent = 'Click "Next" to continue to Step 3.';
            btn2.onclick = () => {
              // Page reload to step 3 (new pageview = more ads)
              const nu = new URL(location.href);
              nu.searchParams.set('istep', '3');
              location.href = nu.toString();
            };
          }
        }, 1000);
      };
    }
  }, 1000);
} else if(istep === 3) {
  step3El.classList.remove('hidden');
  
  // Timer doesn't auto-start - user must click Next
  timer3BigEl.textContent = '10';
  btn3.disabled = false;
  btn3.textContent = 'Next';
  
  btn3.onclick = () => {
    btn3.disabled = true;
    btn3.textContent = 'Please wait...';
    btn3.style.background = 'rgba(255,255,255,0.1)';
    
    let countdown3 = 10;
    const interval3 = setInterval(() => {
      countdown3--;
      if(countdown3 < 0) countdown3 = 0;
      timer3BigEl.textContent = countdown3;
      if(countdown3 === 0) {
        clearInterval(interval3);
        // Enable button for user to click again
        btn3.disabled = false;
        btn3.textContent = '‚úÖ Complete - Continue';
        btn3.style.background = 'rgba(34,197,94,0.2)';
        btn3.style.border = '1px solid rgba(34,197,94,0.5)';
        
        btn3.onclick = () => {
          // Check ToS selection
          const tosRadios = document.querySelectorAll('input[name="tos_radio"]');
          let agreed = false;
          tosRadios.forEach(radio => {
            if(radio.checked && radio.value === 'agree') {
              agreed = true;
            }
          });
          
          if(agreed) {
            // Log final step completion and redirect to destination
            if(window.ADMENSION_ENGAGEMENT) {
              try {
                window.ADMENSION_ENGAGEMENT.logEvent('interstitial_complete', {
                  code: code,
                  adm_code: admCode || 'none',
                  destUrl: linkData.destUrl,
                  chain: linkData.chain,
                  hasAddr: !!linkData.addr
                });
              } catch(e) {}
            }
            
            // Redirect to destination URL (validate URL to prevent open redirects)
            if(linkData && linkData.destUrl) {
              const url = linkData.destUrl;
              if(url.startsWith('http://') || url.startsWith('https://')) {
                location.href = url;
              } else {
                alert('Invalid destination URL. Only http:// and https:// URLs are allowed.');
                location.href = './';
              }
            } else {
              alert('No destination URL found.');
              location.href = './';
            }
          } else {
            // Show countdown and redirect to Step 1
            btn3.disabled = true;
            let countdown = 3;
            btn3.textContent = `You must agree to ToS. Redirecting in ${countdown}...`;
            btn3.style.background = 'rgba(239,68,68,0.2)';
            btn3.style.border = '1px solid rgba(239,68,68,0.5)';
            
            const redirectInterval = setInterval(() => {
              countdown--;
              btn3.textContent = `You must agree to ToS. Redirecting in ${countdown}...`;
              if(countdown === 0) {
                clearInterval(redirectInterval);
                const nu = new URL(location.href);
                nu.searchParams.set('istep', '1');
                nu.searchParams.set('tos_msg', '1');
                location.href = nu.toString();
              }
            }, 1000);
          }
        };
      }
    }, 1000);
  };
}

function renderDailyQuoteStep2() {
  const container = document.getElementById('dailyQuoteStep2');
  if(!container) return;
  
  // Use the daily quote system if available
  if(window.ADMENSION_DAILY_QUOTES) {
    const quote = window.ADMENSION_DAILY_QUOTES.getTodaysQuote();
    const gifUrl = window.ADMENSION_DAILY_QUOTES.getTodaysGif();
    const dayOfYear = window.ADMENSION_DAILY_QUOTES.getDayOfYear();
    
    container.innerHTML = `
      <div class="daily-quote-card" style="
        position: relative;
        background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(12,12,16,0.95) 100%),
                    url('${gifUrl}') center/cover;
        border: 2px solid rgba(255,215,0,0.4);
        border-radius: 16px;
        padding: 24px;
        min-height: 160px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        box-shadow: 0 10px 40px rgba(255,215,0,0.2);
        overflow: hidden;
        margin-bottom: 1rem;
      ">
        <div class="quote-badge" style="
          position: absolute;
          top: 12px;
          right: 12px;
          background: rgba(255,215,0,0.9);
          color: #000;
          padding: 4px 10px;
          border-radius: 8px;
          font-weight: 700;
          font-size: 11px;
          letter-spacing: 0.5px;
        ">
          DAY ${dayOfYear}/365
        </div>
        
        <div class="quote-icon" style="
          font-size: 36px;
          margin-bottom: 12px;
          opacity: 0.9;
        ">üí∞</div>
        
        <blockquote class="quote-text" style="
          font-size: 18px;
          font-weight: 700;
          line-height: 1.4;
          color: #fff;
          text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
          max-width: 100%;
          margin: 0;
          padding: 0 16px;
          position: relative;
          z-index: 1;
        ">
          "${quote}"
        </blockquote>
        
        <div class="quote-attribution" style="
          margin-top: 12px;
          font-size: 12px;
          color: rgba(255,215,0,0.8);
          font-weight: 600;
          letter-spacing: 1px;
        ">
          ‚Äî ADMENSION DAILY MOTIVATION
        </div>
      </div>
    `;
  }
};
</script>

</body>
</html>
